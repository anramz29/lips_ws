<?xml version="1.0"?>
<!-- 
Complete launch file for YOLO segmentation with on-demand keypoint detection
Usage: roslaunch yolo_vision yolo_segmentation_with_distance.launch
Dependencies: interbotix_xslocobot_control stack
Base command: roslaunch interbotix_xslocobot_nav xslocobot_nav.launch robot_model:=locobot_wx250s localization:=true use_lidar:=true 
-->

<launch>
    <!-- Global Arguments -->
    <arg name="robot_name" default="locobot"/>
    <arg name="rviz_frame" default="$(arg robot_name)/odom"/>
    <arg name="rvizconfig" default="$(find yolo_vision)/rviz/xslocobot_description_yolo_seg.rviz"/>
    <arg name="use_rviz" default="true" doc="Set to false to disable RViz visualization"/>

    <!-- Camera Topics -->
    <arg name="rgb_topic" default="/$(arg robot_name)/camera/color/image_raw"/>
    <arg name="depth_topic" default="/$(arg robot_name)/camera/depth/image_rect_raw"/>
    <arg name="camera_info_topic" default="/$(arg robot_name)/camera/depth/camera_info"/>

    <!-- YOLO Segmentation Topics and Parameters -->
    <arg name="seg_model_path" default="$(find yolo_vision)/models/box_and_grasshopper_segmentation.pt"/>
    <arg name="keypoint_model_path" default="$(find yolo_vision)/models/grasshopper_and_boxes_keypoint.pt"/>
    <arg name="confidence_threshold" default="0.5"/>
    <arg name="input_size" default="640"/>

    <!-- Debug Mode -->
    <arg name="debug_mode" default="false" doc="Set to true to enable debug mode"/>

    <!-- Global Frames -->
    <arg name="camera_frame" default="$(arg robot_name)/camera_color_optical_frame"/>
    <arg name="map_frame" default="map"/>

    <!-- Visualization Topics -->
    <arg name="masks_topic" default="camera/yolo/segmentation_masks"/>
    <arg name="boxes_topic" default="camera/yolo/bounding_boxes"/>
    <arg name="depth_visualization_topic" default="camera/yolo/depth_visualization"/>

    <!-- Structured Data Topics -->
    <arg name="bbox_data_topic" default="camera/yolo/detection_boxes"/>
    <arg name="mask_data_topic" default="camera/yolo/detection_masks"/>
    <arg name="class_info_topic" default="camera/yolo/class_information"/>
    <arg name="distance_topic" default="camera/yolo/segmentation_distances"/>
    <arg name="marker_array_topic" default="camera/yolo/marker_array"/>
    <arg name="keypoints_topic" default="camera/yolo/keypoints"/>
    <arg name="keypoints_viz_topic" default="camera/yolo/keypoints_visualization"/>

    <!-- Visualization Options -->
    <arg name="publish_visualizations" default="true" doc="Set to false to disable visualization topics"/>
  
    <!-- PART 1: Launch YOLO Segmentation node -->
    <node name="yolo_segmentation_node" pkg="yolo_vision" type="yolo_segmentation_node.py" output="screen" ns="$(arg robot_name)">
        <!-- Main parameters -->
        <param name="model_path" value="$(arg seg_model_path)"/>
        <param name="image_topic" value="$(arg rgb_topic)"/>
        
        <!-- Visualization topics (optional) -->
        <param name="masks_topic" value="$(arg masks_topic)"/>
        <param name="boxes_topic" value="$(arg boxes_topic)"/>
        
        <!-- Structured data topics -->
        <param name="bbox_data_topic"   value="$(arg bbox_data_topic)"/>
        <param name="mask_data_topic"   value="$(arg mask_data_topic)"/>
        <param name="class_info_topic"  value="$(arg class_info_topic)"/>

        <!-- Rviz -->
        <param name="use_rviz" value="false"/>
        
        <!-- Optional: Disable visualization if not needed -->
        <param name="publish_visualizations" value="$(arg publish_visualizations)"/>
    </node>

    <!-- PART 2: Launch Segmentation Distance node -->
    <node name="segmentation_distance_node" pkg="yolo_vision" type="segmentation_distance_node.py" output="screen" ns="$(arg robot_name)">
        <!-- Debug Mode -->
        <param name="debug_mode" value="$(arg debug_mode)"/>

        <!-- Image sources -->
        <param name="depth_image_topic" value="$(arg depth_topic)"/>
        <param name="mask_data_topic" value="$(arg mask_data_topic)"/>
        <param name="masks_topic" value="$(arg masks_topic)"/>
        
        <!-- Output topics -->
        <param name="depth_visualization_topic" value="$(arg depth_visualization_topic)"/>
        <param name="distance_topic" value="$(arg distance_topic)"/>

        <!-- Rviz -->
        <param name="use_rviz" value="false"/>
    </node>

    <!-- PART 3: Launch Segmentation Object Mapper node -->
    <node name="segmentation_object_mapper_node" pkg="yolo_vision" type="segmentation_object_mapper_node.py" output="screen" ns="$(arg robot_name)">
        <!-- Debug Mode -->
        <param name="debug_mode" value="$(arg debug_mode)"/>

        <!-- Frames -->
        <param name="camera_frame" value="$(arg camera_frame)"/>
        <param name="map_frame" value="$(arg map_frame)"/>

        <!-- Input topics -->
        <param name="distance_topic" value="$(arg distance_topic)"/>
        <param name="camera_info_topic" value="$(arg camera_info_topic)"/>

        <!-- Output topics -->
        <param name="marker_array_topic" value="$(arg marker_array_topic)"/>
    </node>

    <!-- PART 4: Launch Keypoint Activation Service -->
    <node name="keypoint_activation_node" pkg="yolo_vision" type="yolo_keypoint_activation.py" output="screen" ns="$(arg robot_name)">
        <param name="robot_name" value="$(arg robot_name)"/>
    </node>

    <!-- PART 5: Launch Keypoint Detection node (initially disabled) -->
    <node name="keypoint_detection_node" pkg="yolo_vision" type="yolo_keypoint_detection_node.py" output="screen" ns="$(arg robot_name)">
        <!-- Main parameters -->
        <param name="model" value="$(arg keypoint_model_path)"/>
        <param name="image_topic" value="$(arg rgb_topic)"/>
        <param name="confidence_threshold" value="$(arg confidence_threshold)"/>
        <param name="input_size" value="$(arg input_size)"/>
        <param name="debug_mode" value="$(arg debug_mode)"/>
        
        <!-- Output topics -->
        <param name="keypoints_topic" value="$(arg keypoints_topic)"/>
        <param name="keypoints_viz_topic" value="$(arg keypoints_viz_topic)"/>
        
        <!-- Camera frame -->
        <param name="camera_frame" value="$(arg camera_frame)"/>
    </node>
    
    <!-- RViz (conditionally launched) -->
    <group if="$(arg use_rviz)">
        <node name="rviz" pkg="rviz" type="rviz" 
            args="-f $(arg rviz_frame) -d $(arg rvizconfig)"
            ns="$(arg robot_name)">
            <remap from="/clicked_point" to="clicked_point"/>
            <remap from="/initialpose" to="initialpose"/>
            <remap from="/move_base_simple/goal" to="move_base_simple/goal"/>
        </node>
    </group>
</launch>